<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>MCP Doctor Assistant</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      /* ... existing styles ... */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 2rem 1rem;
      }
      .container {
        max-width: 900px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }
      .header {
        text-align: center;
        color: white;
        margin-bottom: 1rem;
      }
      .header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      }
      .header p {
        font-size: 1rem;
        opacity: 0.95;
      }
      .card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      }
      .chat-container {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        height: 500px;
      }
      .history {
        flex: 1;
        overflow-y: auto;
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
        font-size: 0.95rem;
        line-height: 1.6;
        white-space: pre-wrap;
        word-break: break-word;
      }
      .input-group {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }
      textarea {
        width: 100%;
        padding: 1rem;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-family: inherit;
        font-size: 0.95rem;
        resize: none;
        transition: border-color 0.3s;
      }
      textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }
      button {
        padding: 0.75rem 1.5rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
      }
      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
      }
      button:active {
        transform: translateY(0);
      }
      .slots-container {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
      }
      .slots-label {
        font-weight: 600;
        color: #333;
        margin-bottom: 1rem;
        display: block;
      }
      .slots-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 0.75rem;
      }
      .slot-button {
        padding: 0.75rem 1rem;
        background: white;
        color: #667eea;
        border: 2px solid #667eea;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s;
      }
      .slot-button:hover {
        background: #667eea;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      }
      .doctor-info {
        background: #f0f4ff;
        padding: 1rem;
        border-radius: 8px;
        border-left: 4px solid #667eea;
        font-size: 0.9rem;
        color: #555;
      }
      .doctor-info strong {
        color: #667eea;
      }
      @media (max-width: 600px) {
        .header h1 {
          font-size: 1.8rem;
        }
        .chat-container {
          height: auto;
        }
        .slots-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
    <!-- React + ReactDOM via CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Config: Assumes BASE_URL is defined here, e.g. const BASE_URL = "http://localhost:3000"; -->
    <script src="./config.js"></script>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üë®‚Äç‚öïÔ∏è Doctor Assistant</h1>
        <p>AI-powered appointment scheduling</p>
      </div>
      <div id="app"></div>
    </div>

    <script>
      const { useState, useEffect } = React;

      // Fallback if config.js fails to load
      if (typeof BASE_URL === "undefined") {
        console.warn(
          "BASE_URL not found in config.js, defaulting to localhost:4000"
        );
        window.BASE_URL = "http://localhost:4000";
      }

      function App() {
        const [sessionId] = useState(() => {
          const s = localStorage.getItem("mcp_session");
          if (s) return s;
          const id = crypto.randomUUID();
          localStorage.setItem("mcp_session", id);
          return id;
        });

        const [prompt, setPrompt] = useState("");
        const [history, setHistory] = useState("");
        const [lastSlots, setLastSlots] = useState([]);
        const [lastDoctor, setLastDoctor] = useState(null);
        const [loading, setLoading] = useState(false);

        function convertToEnglish(data) {
          if (data.summary) return data.summary;
          if (data.ok && data.success)
            return `‚úÖ ${data.message || "Success!"}`;
          if (!data.ok && data.error) return `‚ùå Error: ${data.error}`;
          if (data.slots && Array.isArray(data.slots)) {
            const count = data.slots.length;
            const doctorName = data.doctor?.name || "the doctor";
            return `Found ${count} available appointment slot${
              count !== 1 ? "s" : ""
            } with ${doctorName}.`;
          }
          return JSON.stringify(data, null, 2);
        }

        async function send() {
          if (!prompt.trim()) return;

          setLoading(true);
          const currentPrompt = prompt;
          setPrompt(""); // Clear input immediately

          setHistory((h) => h + `\n> ${currentPrompt}\n`);

          try {
            const res = await fetch(`${BASE_URL}/agent/prompt`, {
              method: "POST",
              headers: { "content-type": "application/json" },
              body: JSON.stringify({ prompt: currentPrompt, sessionId }),
            });
            const data = await res.json();

            // Display Agent Summary
            const reply =
              data.summary ||
              (data.ok ? "Action completed." : `Error: ${data.error}`);
            setHistory((h) => h + `${reply}\n`);

            // Handle UI Updates based on Tool Results
            if (data && data.ok && Array.isArray(data.actions)) {
              for (const a of data.actions) {
                const toolName = a?.action?.tool;
                const result = a?.result;

                // 1. Handle Availability (Show Slots)
                if (toolName === "availability" && result) {
                  if (result.slots) setLastSlots(result.slots);

                  // Update Doctor Info Context
                  if (result.doctor) setLastDoctor(result.doctor);
                  else if (a.action.input?.doctorName) {
                    setLastDoctor({
                      name: a.action.input.doctorName,
                      id: a.action.input.doctorId,
                    });
                  }
                }

                // 2. Handle Schedule (Clear Slots on Success)
                if (toolName === "schedule" && a.ok) {
                  setLastSlots([]);
                  // Optional: Show success animation or toast here
                }
              }
            }
          } catch (err) {
            setHistory((h) => h + `\n[Network Error] ${String(err)}\n`);
          } finally {
            setLoading(false);
          }
        }

        async function scheduleSlot(slot) {
          const input = {
            doctorId: lastDoctor ? lastDoctor.id : undefined,
            doctorName: lastDoctor ? lastDoctor.name : "Dr. Ahuja",
            patientName: "Jane User",
            patientEmail: "jane@example.com", // In a real app, ask user for this
            start: slot.start,
            end: slot.end,
          };

          try {
            const res = await fetch(`${BASE_URL}/mcp/invoke`, {
              method: "POST",
              headers: { "content-type": "application/json" },
              body: JSON.stringify({ tool: "schedule", input, sessionId }),
            });
            const j = await res.json();

            const englishText = convertToEnglish(j);
            setHistory(
              (h) =>
                h +
                `\n> Booking slot: ${new Date(
                  slot.start
                ).toLocaleTimeString()}\n${englishText}\n`
            );

            if (j.ok) {
              setLastSlots([]); // Clear slots after booking
            }
          } catch (err) {
            setHistory((h) => h + `\n‚ùå Schedule error: ${String(err)}\n`);
          }
        }

        return React.createElement(
          "div",
          null,
          React.createElement(
            "div",
            { className: "card chat-container" },
            React.createElement(
              "div",
              { className: "history" },
              history ||
                "Chat history will appear here. Try: 'Book Dr. Sharma for 10am'"
            )
          ),

          // Doctor Context Info
          lastDoctor
            ? React.createElement(
                "div",
                { className: "card doctor-info" },
                React.createElement("strong", null, `üë®‚Äç‚öïÔ∏è ${lastDoctor.name}`),
                React.createElement(
                  "div",
                  null,
                  ` (ID: ${lastDoctor.id || "Unknown"})`
                )
              )
            : null,

          // Slot Buttons
          lastSlots && lastSlots.length > 0
            ? React.createElement(
                "div",
                { className: "card slots-container" },
                React.createElement(
                  "span",
                  { className: "slots-label" },
                  "üìÖ Available appointment times:"
                ),
                React.createElement(
                  "div",
                  { className: "slots-grid" },
                  lastSlots.map((s) =>
                    React.createElement(
                      "button",
                      {
                        key: s.id || s.start,
                        className: "slot-button",
                        onClick: () => scheduleSlot(s),
                      },
                      new Date(s.start).toLocaleTimeString([], {
                        hour: "2-digit",
                        minute: "2-digit",
                      })
                    )
                  )
                )
              )
            : null,

          // Input Area
          React.createElement(
            "div",
            { className: "card" },
            React.createElement(
              "div",
              { className: "input-group" },
              React.createElement("textarea", {
                rows: 3,
                value: prompt,
                onChange: (e) => setPrompt(e.target.value),
                placeholder: "Type your request here...",
                onKeyPress: (e) => {
                  if (e.key === "Enter" && !e.shiftKey) {
                    e.preventDefault();
                    send();
                  }
                },
              }),
              React.createElement(
                "button",
                { onClick: send, disabled: loading },
                loading ? "Thinking..." : "üì§ Send Message"
              )
            )
          )
        );
      }

      ReactDOM.createRoot(document.getElementById("app")).render(
        React.createElement(App)
      );
    </script>
  </body>
</html>
